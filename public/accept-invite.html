<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accepter l'invitation - Grimoire d'√Åether</title>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0a0a1a 0%, #1a1526 100%);
      color: #e0f2fe;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      text-align: center;
      padding: 2rem;
      max-width: 500px;
      z-index: 1;
    }
    
    h1 {
      color: #c4b5fd;
      margin-bottom: 1rem;
    }
    
    .message {
      color: #ddd6fe;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    
    .button {
      background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
      color: white !important;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin: 1rem 0;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      pointer-events: auto !important;
      z-index: 9999;
      position: relative;
    }
    
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    .status {
      color: #c4b5fd;
      margin: 1rem 0;
      min-height: 1.5rem;
    }
    
    .error {
      color: #f87171;
      margin-top: 1rem;
    }
    
    .help-text {
      color: #94a3b8;
      font-size: 0.9rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÆ Accepter l'invitation</h1>
    <p class="message">Veuillez cr√©er votre mot de passe pour acc√©der au Grimoire d'√Åether.</p>
    
    <p class="status" id="status">Chargement...</p>
    
    <button class="button" id="open-btn" onclick="openInviteForm()">
      Ouvrir le formulaire d'invitation
    </button>
    
    <p class="error" id="error" style="display: none;"></p>
    
    <p class="help-text">
      Cliquez sur le bouton ci-dessus pour ouvrir le formulaire de cr√©ation de mot de passe.
    </p>
  </div>
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <script>
    let widgetInitialized = false;
    
    // Fonction pour ouvrir le formulaire
    function openInviteForm() {
      console.log('Bouton cliqu√©');
      
      if (!widgetInitialized) {
        document.getElementById('status').textContent = 'Initialisation du widget...';
        initWidget();
        return;
      }
      
      try {
        const hash = window.location.hash;
        document.getElementById('status').textContent = 'Ouverture du formulaire...';
        
        if (hash && hash.includes('invite_token=')) {
          netlifyIdentity.open('invite');
        } else {
          netlifyIdentity.open('login');
        }
      } catch (e) {
        console.error('Erreur:', e);
        document.getElementById('status').textContent = 'Erreur lors de l\'ouverture. Veuillez r√©essayer.';
        showError('Erreur: ' + e.message);
      }
    }
    
    // Fonction pour initialiser le widget
    function initWidget() {
      // Attendre que le script soit charg√©
      if (typeof netlifyIdentity === 'undefined') {
        setTimeout(initWidget, 200);
        return;
      }
      
      try {
        // Initialiser le widget
        netlifyIdentity.init();
        widgetInitialized = true;
        document.getElementById('status').textContent = 'Pr√™t. Cliquez sur le bouton pour ouvrir le formulaire.';
        
        // G√©rer les √©v√©nements
        netlifyIdentity.on('init', function(user) {
          if (user) {
            window.location.href = '/admin/';
          }
        });
        
        netlifyIdentity.on('login', function(user) {
          window.location.href = '/admin/';
        });
        
        netlifyIdentity.on('error', function(err) {
          console.error('Erreur Netlify Identity:', err);
          showError('Erreur: ' + (err.message || 'Une erreur est survenue'));
        });
        
        // Ouvrir automatiquement si token pr√©sent
        const hash = window.location.hash;
        if (hash && hash.includes('invite_token=')) {
          setTimeout(function() {
            try {
              netlifyIdentity.open('invite');
              document.getElementById('status').textContent = 'Formulaire ouvert...';
            } catch (e) {
              console.error('Erreur ouverture auto:', e);
            }
          }, 500);
        }
        
      } catch (e) {
        console.error('Erreur initialisation:', e);
        showError('Erreur lors de l\'initialisation: ' + e.message);
        document.getElementById('status').textContent = 'Erreur. Cliquez sur le bouton pour r√©essayer.';
      }
    }
    
    // Fonction pour afficher les erreurs
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
    
    // D√©marrer l'initialisation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initWidget, 500);
      });
    } else {
      setTimeout(initWidget, 500);
    }
  </script>
</body>
</html>
