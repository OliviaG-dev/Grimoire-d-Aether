<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/public/images/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Grimoire d'Áether - Grimoire dédié aux cartes divinatoires (Tarots, Oracles, jeux mystiques). Encyclopédie personnelle avec fiches complètes des jeux et cartes, incluant mots-clés, symboles, énergies et significations." />
    <title>Grimoire d'Áether</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Netlify Identity Widget - nécessaire pour les redirections -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Script pour configurer Netlify Identity et rediriger les tokens -->
    <script>
      // Configurer Netlify Identity pour utiliser localhost en développement
      (function() {
        // Détecter si on est en développement local
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (isLocalhost) {
          // En développement, intercepter les redirections vers la production
          // Cela empêche Netlify Identity de rediriger vers l'URL de production
          const originalLocation = window.location;
          const originalReplace = window.location.replace;
          const originalAssign = window.location.assign;
          
          // Intercepter window.location.replace
          window.location.replace = function(url) {
            if (typeof url === 'string' && !url.includes('localhost') && !url.includes('127.0.0.1') && !url.startsWith('/')) {
              console.log('[Netlify Identity] Redirection vers la production interceptée:', url);
              // Ne pas rediriger, laisser React Router gérer les redirections
              return;
            }
            return originalReplace.apply(this, arguments);
          };
          
          // Intercepter window.location.assign
          window.location.assign = function(url) {
            if (typeof url === 'string' && !url.includes('localhost') && !url.includes('127.0.0.1') && !url.startsWith('/')) {
              console.log('[Netlify Identity] Redirection vers la production interceptée:', url);
              return;
            }
            return originalAssign.apply(this, arguments);
          };
        }
        
        // Vérifier si un token Netlify Identity est présent dans l'URL
        const hash = window.location.hash;
        
        if (hash) {
          // Token d'invitation : rediriger vers /login avec le token
          if (hash.includes('invite_token=')) {
            window.location.replace('/login' + hash);
            return;
          }
          
          // Autres tokens (recovery, confirmation) : rediriger vers /login
          if (hash.includes('recovery_token=') || hash.includes('confirmation_token=')) {
            window.location.replace('/login' + hash);
            return;
          }
          
          // Si le hash est vide ou ne contient pas de token, le nettoyer
          if (hash === '#' || hash === '') {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
          }
        }
      })();
    </script>
  </body>
</html>
